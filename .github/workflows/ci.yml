name: CI

on:
  pull_request:
  push:
    branches: ["main"]

jobs:
  test-build-push:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    steps:
    # ---------------------------------------------------
    # Checkout
    # ---------------------------------------------------
    - name: Checkout repository
      uses: actions/checkout@v4

    # ---------------------------------------------------
    # Python setup
    # ---------------------------------------------------
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    # ---------------------------------------------------
    # Install dependencies
    # ---------------------------------------------------
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -e .

    # ---------------------------------------------------
     # Run DVC
    # ---------------------------------------------------

    - name: Run DVC train to generate model (main only)
      if: github.ref == 'refs/heads/main'
      run: |
         dvc repro train
    

    - name: Verify model artifacts exist (main only)
      if: github.ref == 'refs/heads/main'
      run: |
          ls -lah models || true
          test -f models/model.keras || (echo "Missing models/model.keras" && exit 1)
          test -f models/label_map.json || (echo "Missing models/label_map.json" && exit 1)



    # ---------------------------------------------------
    # Run tests
    # ---------------------------------------------------
    - name: Run unit tests
      run: pytest -q

    # ---------------------------------------------------
    # Validate Dockerfiles (fail early if missing)
    # ---------------------------------------------------
    - name: Verify Dockerfiles exist
      run: |
        echo "Checking dockerfiles..."
        ls -la
        test -f Dockerfile || (echo " Dockerfile missing" && exit 1)
        test -f Dockerfile.ui || (echo " Dockerfile.ui missing" && exit 1)

    - name: DEBUG â€” verify model exists before docker build
      run: |
           echo "=== WORKSPACE ==="
           pwd
           ls -lah
           echo "=== MODELS ==="
           ls -lah models || echo "NO MODELS DIR" 
    

    # ---------------------------------------------------
    # Setup Docker Buildx
    # ---------------------------------------------------
    - name: Set up Docker Buildx
      if: github.ref == 'refs/heads/main'
      uses: docker/setup-buildx-action@v3

    # ---------------------------------------------------
    # Login to GitHub Container Registry
    # ---------------------------------------------------
    - name: Log in to GHCR
      if: github.ref == 'refs/heads/main'
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    # ---------------------------------------------------
    # Build & Push API Image
    # ---------------------------------------------------
    - name: Build and push API image
      if: github.ref == 'refs/heads/main'
      uses: docker/build-push-action@v6
      with:
        context: .
        file: Dockerfile
        push: true
        tags: |
          ghcr.io/${{ github.repository_owner }}/cats-dogs-inference:api
          ghcr.io/${{ github.repository_owner }}/cats-dogs-inference:api-${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    # ---------------------------------------------------
    # Build & Push UI Image
    # ---------------------------------------------------
    - name: Build and push UI image
      if: github.ref == 'refs/heads/main'
      uses: docker/build-push-action@v6
      with:
        context: .
        file: Dockerfile.ui
        push: true
        tags: |
          ghcr.io/${{ github.repository_owner }}/cats-dogs-inference:ui
          ghcr.io/${{ github.repository_owner }}/cats-dogs-inference:ui-${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
