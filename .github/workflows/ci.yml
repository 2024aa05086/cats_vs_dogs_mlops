name: CI

on:
  pull_request:
  push:
    branches: ["main"]

jobs:
  test-build-push:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    steps:
    # ---------------------------------------------------
    # Checkout
    # ---------------------------------------------------
    - name: Checkout repository
      uses: actions/checkout@v4

    # ---------------------------------------------------
    # Python setup
    # ---------------------------------------------------
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    # ---------------------------------------------------
    # Install dependencies
    # ---------------------------------------------------
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -e .

    # ---------------------------------------------------
    # DVC Training (main only)
    # ---------------------------------------------------
    - name: Run DVC train
      if: github.ref == 'refs/heads/main'
      run: dvc repro train

    - name: Configure Git
      if: github.ref == 'refs/heads/main'
      run: |
        git config --global user.name "github-actions"
        git config --global user.email "github-actions@github.com"

    - name: Commit DVC lock + ignore rules
      if: github.ref == 'refs/heads/main'
      run: |
        git add dvc.lock models/.gitignore .dvc/.gitignore dvc.yaml
        git diff --cached --quiet || git commit -m "CI: Update pipeline lock [skip ci]"
        git push

    - name: Push model to DVC remote (non-blocking)
      if: github.ref == 'refs/heads/main'
      run: |
        dvc push || echo "Skipping dvc push: no remote configured"

    - name: Verify model artifacts
      if: github.ref == 'refs/heads/main'
      run: |
        ls -lah models
        test -f models/model.keras
        test -f models/label_map.json

    # ---------------------------------------------------
    # Tests
    # ---------------------------------------------------
    - name: Run unit tests
      run: pytest -q

    # ---------------------------------------------------
    # Verify Dockerfiles
    # ---------------------------------------------------
    - name: Verify Dockerfiles exist
      run: |
        test -f Dockerfile
        test -f Dockerfile.ui

    # ---------------------------------------------------
    # Setup Docker Buildx
    # ---------------------------------------------------
    - name: Setup Buildx
      if: github.ref == 'refs/heads/main'
      uses: docker/setup-buildx-action@v3

    # ---------------------------------------------------
    # Login GHCR
    # ---------------------------------------------------
    - name: Login to GHCR
      if: github.ref == 'refs/heads/main'
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    # ---------------------------------------------------
    # FORCE BUILD ARG (cache buster)
    # ---------------------------------------------------
    - name: Generate cache buster
      if: github.ref == 'refs/heads/main'
      id: vars
      run: echo "BUILD_TIME=$(date +%s)" >> $GITHUB_OUTPUT

    # ---------------------------------------------------
    # Build & Push API (FORCED)
    # ---------------------------------------------------
    - name: Build & Push API image (force overwrite)
      if: github.ref == 'refs/heads/main'
      uses: docker/build-push-action@v6
      with:
        context: .
        file: Dockerfile
        push: true
        pull: true
        no-cache: true
        provenance: false
        build-args: |
          CACHE_BUSTER=${{ steps.vars.outputs.BUILD_TIME }}
        tags: |
          ghcr.io/${{ github.repository_owner }}/cats-dogs-inference:backend-api
          ghcr.io/${{ github.repository_owner }}/cats-dogs-inference:backend-api-${{ github.sha }}

    # ---------------------------------------------------
    # Build & Push UI (FORCED)
    # ---------------------------------------------------
    - name: Build & Push UI image (force overwrite)
      if: github.ref == 'refs/heads/main'
      uses: docker/build-push-action@v6
      with:
        context: .
        file: Dockerfile.ui
        push: true
        pull: true
        no-cache: true
        provenance: false
        build-args: |
          CACHE_BUSTER=${{ steps.vars.outputs.BUILD_TIME }}
        tags: |
          ghcr.io/${{ github.repository_owner }}/cats-dogs-inference:ui
          ghcr.io/${{ github.repository_owner }}/cats-dogs-inference:ui-${{ github.sha }}
